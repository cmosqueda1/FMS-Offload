<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Offload Helper</title>
<style>
  :root{--bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;--accent:#7c3aed;--accent2:#22d3ee;--ok:#10b981;--bad:#ef4444;--border:#1f2a3a}
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:0 16px 64px}
  h1{margin:0 0 6px;font-size:26px;font-weight:800}
  .sub{color:var(--muted);margin-bottom:18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .stack{display:grid;gap:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text]{width:340px;background:#0b0f19;border:1px solid var(--border);color:var(--text);border-radius:14px;padding:10px 12px;font-size:14px;outline:none}
  textarea{width:100%;min-height:220px;background:#0b0f19;border:1px solid var(--border);color:var(--text);border-radius:14px;padding:12px 14px;font-size:14px;line-height:1.4;resize:vertical;outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{cursor:pointer;border:1px solid transparent;border-radius:14px;padding:12px 16px;font-weight:700;font-size:14px}
  .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#060913}
  .btn-ghost{background:transparent;border-color:var(--border);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0b0f19;font-size:12px;color:var(--muted)}
  .bar{height:12px;border-radius:999px;background:#0b0f19;border:1px solid var(--border);overflow:hidden}
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--ok),var(--accent2));transition:width .2s ease}
  .muted{color:var(--muted);font-size:12px}
  .err{color:var(--bad);font-size:12px}
  pre{white-space:pre-wrap;word-break:break-word;background:#0b0f19;border:1px solid var(--border);border-radius:14px;padding:12px;font-size:13px;max-height:420px;overflow:auto}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .brand{display:inline-flex;align-items:center;gap:10px}
  .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 18px rgba(124,58,237,.7)}
  .kvs{display:flex;gap:10px;flex-wrap:wrap}

  /* Dropdown modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:min(840px,92vw);max-height:80vh;background:#0f1420;border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:flex;flex-direction:column}
  .modal header{display:flex;gap:10px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
  .modal header input{flex:1;width:auto}
  .modal .list{overflow:auto}
  .item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px dashed #182234;cursor:pointer}
  .item:hover{background:#0b0f19}
  .badge{font-size:11px;border:1px solid var(--border);padding:3px 8px;border-radius:999px;color:var(--muted)}
  .code{font-weight:800;letter-spacing:.3px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="brand"><span class="dot"></span><h1 style="margin:0">FMS Offload Helper</h1></div>
    <div class="pill" id="termStatus">Terminals: —</div>
  </div>
  <div class="sub">Enter a valid <b>Terminal</b> (from live list), paste PROs in any format, then <b>Run Offload</b>. Use <b>Browse</b> to pick from a dropdown.</div>

  <div class="card stack">
    <div class="row">
      <div>
        <label for="terminal">Terminal (live-validated)</label>
        <input type="text" id="terminal" placeholder="e.g., HAY or SEFL-DFW" autocomplete="off"/>
        <div class="kvs">
          <div class="muted" id="termMeta">—</div>
          <div class="err" id="termErr" style="display:none"></div>
        </div>
      </div>
      <button class="btn btn-ghost" id="browseTerms">Browse Terminals ⌄</button>
      <button class="btn btn-ghost" id="refreshTerms">Refresh Terminals</button>
      <span class="pill">Cap: 150 PROs</span>
      <span class="pill">Retries: 2</span>
    </div>

    <div>
      <label for="input">Tracking Numbers (any separators; we extract 6–14 digit PROs)</label>
      <textarea id="input" placeholder="61807173
61804271, 61804311
3178258 3178259
18391571"></textarea>
    </div>

    <div class="row">
      <button class="btn btn-primary" id="run" disabled>Run Offload</button>
      <button class="btn btn-ghost" id="preview" disabled>Dry-Run Preview</button>
      <button class="btn btn-ghost" id="export" disabled>Export Results (.txt)</button>
    </div>

    <div class="row" style="justify-content:space-between">
      <div class="muted" id="status">Idle</div>
      <div class="muted" id="eta">ETA —</div>
    </div>
    <div class="bar"><div class="fill" id="fill"></div></div>
    <div class="muted" id="counts">0/0</div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong>Output</strong>
      <span class="muted">Format: <code>PRO -> DO - successfully offloaded at TERMINAL</code></span>
    </div>
    <pre id="out"></pre>
  </div>
</div>

<!-- Modal for terminal dropdown -->
<div class="modal-back" id="mb">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mlabel">
    <header>
      <strong id="mlabel">Select Terminal</strong>
      <input type="text" id="msearch" placeholder="Search (code or name)…" autocomplete="off"/>
      <button class="btn btn-ghost" id="mclose">Close</button>
    </header>
    <div class="list" id="mlist"></div>
  </div>
</div>

<script>
(() => {
  // =========================
  // CONFIG
  // =========================
  const BASE       = "https://fms.item.com";           // Change to your proxy origin if needed
  const COMPANY_ID = "SBFH";
  const FMS_CLIENT = "FMS_WEB";
  const USERNAME   = "RaulEscobar";
  const PASSWORD   = "FMSoffload1!";
  const MAX_ORDERS = 150;
  const RETRIES    = 2;

  // Required endpoints
  const LOGIN_URL  = `${BASE}/fms-platform-user/Auth/Login`;
  const SEARCH_URL = `${BASE}/fms-platform-order/shipment-orders/query`;
  const OFFLOAD_URL= `${BASE}/fms-platform-order/status/shipment/set-offload`;

  // Terminal list endpoint (per your request)
  const TERM_URL   = `${BASE}/fms-platform-dispatch-management/public-location/current-company-terminals?terminalType=0`;

  // DOM
  const $ = id => document.getElementById(id);
  const termInput = $("terminal");
  const termMeta = $("termMeta"), termErr = $("termErr"), termStatus = $("termStatus");
  const input  = $("input");
  const runBtn = $("run");
  const prevBtn= $("preview");
  const expBtn = $("export");
  const out    = $("out");
  const status = $("status");
  const eta    = $("eta");
  const fill   = $("fill");
  const counts = $("counts");
  const refreshBtn = $("refreshTerms");
  const browseBtn  = $("browseTerms");

  // Modal
  const mb = $("mb"), mlist = $("mlist"), msearch = $("msearch"), mclose = $("mclose");

  // State
  let TOKEN = null;
  let TERMS = [];              // [{value, text, terminal_type}]
  let TERM_MAP = new Map();    // value -> object

  // Helpers
  function kCanonical(x){ return String(x||"").trim().toUpperCase(); }
  function parsePros(text){ return (text.match(/\b\d{6,14}\b/g) || []); }
  function now(){ return Date.now(); }
  function setProg(done,total,startTs){
    const frac = total? (done/total) : 0;
    fill.style.width = (frac*100).toFixed(0)+"%";
    counts.textContent = `${done}/${total}`;
    if (!total){ eta.textContent = "ETA —"; return; }
    const elapsed = (Date.now()-startTs)/1000;
    const rate = done ? done/elapsed : 0;
    const rem = rate ? (total-done)/rate : Infinity;
    eta.textContent = `ETA ${isFinite(rem)?fmt(rem):"—"}`;
  }
  function fmt(sec){
    sec = Math.max(0,Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60;
    return m? `${m}m ${String(s).padStart(2,"0")}s` : `${s}s`;
  }
  function line(msg){ out.textContent += (out.textContent? "\n":"") + msg; }
  function resetOutput(){ out.textContent=""; setProg(0,0,now()); status.textContent="Idle"; eta.textContent="ETA —"; }
  function disableRun(disabled=true){ runBtn.disabled = disabled; prevBtn.disabled = disabled; }
  function showErr(msg){ termErr.style.display="block"; termErr.textContent = msg; }
  function hideErr(){ termErr.style.display="none"; termErr.textContent = ""; }

  termInput.addEventListener("input", () => {
    const pos = termInput.selectionStart;
    termInput.value = kCanonical(termInput.value);
    termInput.setSelectionRange(pos,pos);
    validateTerminal();
  });

  // Auth
  async function auth(force=false){
    if (TOKEN && !force) return TOKEN;
    const headers = {"fms-client":FMS_CLIENT,"Content-Type":"application/json"};
    const body = { account: USERNAME, password: PASSWORD };
    const r = await fetch(LOGIN_URL,{method:"POST",headers,body:JSON.stringify(body)});
    if (!r.ok) throw new Error(`Auth HTTP ${r.status}`);
    const j = await r.json().catch(()=> ({}));
    TOKEN = j.token || j?.data?.token || j?.result?.token || "";
    if (!TOKEN) throw new Error("No token returned");
    return TOKEN;
  }

  // Load terminals
  async function fetchTerminals(){
    const token = await auth();
    const headers = {
      "accept":"application/json, text/plain, */*",
      "fms-client": FMS_CLIENT,
      "fms-token": token,
      "company-id": COMPANY_ID,
      "actual-operate-time": new Date().toISOString().slice(0,10)
    };
    const r = await fetch(TERM_URL,{method:"GET",headers});
    if (!r.ok) throw new Error(`Terminal list HTTP ${r.status}`);
    const j = await r.json();
    const items = j?.data?.items || [];
    TERMS = [];
    TERM_MAP.clear();
    const counts = {REVENUE:0, CONTRACT:0, RETAILER_DISTRIBUTION_CENTER:0, OTHER:0};

    for (const it of items){
      const value = kCanonical(it.value);
      if (!value) continue;
      const row = { value, text: it.text || value, terminal_type: it.terminal_type || "OTHER" };
      TERMS.push(row);
      TERM_MAP.set(value, row);
      if (counts[row.terminal_type] !== undefined) counts[row.terminal_type]++; else counts.OTHER++;
    }
    TERMS.sort((a,b)=>a.value.localeCompare(b.value));

    termStatus.textContent = TERMS.length ? `Terminals: ${TERMS.length} ✓` : `Terminals: 0`;
    termMeta.textContent = TERMS.length
      ? `Loaded • Revenue ${counts.REVENUE||0} • Contract ${counts.CONTRACT||0} • Retail ${counts.RETAILER_DISTRIBUTION_CENTER||0}`
      : "—";

    // render modal list
    renderList();
    validateTerminal();
    return TERMS.length;
  }

  function validateTerminal(){
    hideErr();
    const key = kCanonical(termInput.value);
    const ok = key && TERM_MAP.has(key);
    disableRun(!ok);
    if (!key){ showErr("Enter a terminal or click Browse."); return; }
    if (!ok){ showErr("Not in live list. Pick from Browse or refresh terminals."); return; }
  }

  function renderList(filter=""){
    const q = kCanonical(filter);
    mlist.innerHTML = "";
    for (const t of TERMS){
      if (q && !(t.value.includes(q) || kCanonical(t.text).includes(q))) continue;
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div><span class="code">${t.value}</span> — <span class="muted">${t.text.replace(/</g,"&lt;")}</span></div>
        <span class="badge">${t.terminal_type}</span>`;
      el.addEventListener("click", ()=>{
        termInput.value = t.value;
        closeModal();
        validateTerminal();
      });
      mlist.appendChild(el);
    }
    if (!mlist.children.length){
      const none = document.createElement("div");
      none.className = "item";
      none.innerHTML = `<div class="muted">No matches</div>`;
      mlist.appendChild(none);
    }
  }

  function openModal(){ mb.style.display="flex"; msearch.value=""; renderList(); msearch.focus(); }
  function closeModal(){ mb.style.display="none"; }

  // Search & Offload
  async function searchOrders(token, tracking_nos){
    const headers = {
      "fms-client":FMS_CLIENT,
      "fms-token":token,
      "Content-Type":"application/json",
      "Company-Id": COMPANY_ID
    };
    const body = {
      bill_to_accounts:[], bols:[], business_client:"",
      consignee_state:[], consignee_terminals:[], consignee_zip_codes:[],
      current_locations:[], customer_references:[], delayed:false,
      delivery_appointment:[], delivery_date:[], desired_delivery_date:[],
      exception:false, hold:false, lh_eta_date:[], lh_etd_date:[],
      lhs:[], master_order_ids:[], order_nos:[], origin_states:[],
      origin_zip_codes:[], page_number:1, page_size: Math.min(tracking_nos.length, MAX_ORDERS),
      pickup_appointment:[], pickup_complete_date:[], po_nos:[], pu_nos:[],
      record_status:"0", request_pickup_date:[], service_levels:[],
      service_terminals:[], shipment_types:[], shipper_terminals:[],
      status:[], sub_status:[], tracking_nos, trips:[]
    };
    const r = await fetch(SEARCH_URL,{method:"POST",headers,body:JSON.stringify(body)});
    if (!r.ok) throw new Error(`Search HTTP ${r.status}`);
    return r.json();
  }

  function buildMap(searchJson){
    const map = {};
    let items = [];
    if (Array.isArray(searchJson?.items)) items = searchJson.items;
    else if (Array.isArray(searchJson?.data?.items)) items = searchJson.data.items;

    for (const it of items){
      const pro = String(it.tracking_no ?? it.trackingNo ?? "").trim();
      const order = String(it.order_no ?? it.orderNo ?? "").trim();
      if (/^\d{6,14}$/.test(pro) && /^DO\d{6,}$/.test(order)) map[pro] = order;
    }
    return map;
  }

  function extractKey(DO){
    const m = String(DO).match(/\bDO(\d{6,})\b/i);
    return m ? m[1] : null;
  }

  async function offloadAll({token, terminal, pairs}){
    const headers = {
      "Accept":"application/json, text/plain, */*",
      "Content-Type":"application/json",
      "fms-client": FMS_CLIENT,
      "fms-token": token,
      "company-id": COMPANY_ID,
      "actual-operate-time": new Date().toISOString().slice(0,10)
    };
    const start = now();
    const total = pairs.length;
    const results = [];
    setProg(0,total,start);

    for (let i=0;i<pairs.length;i++){
      const [pro, DO] = pairs[i];
      const key = extractKey(DO);
      let ok = false;
      if (key){
        const payload = { order_status:"Override Offload", order_keys:[Number(key)], terminal };
        for (let a=0;a<=RETRIES;a++){
          try{
            const r = await fetch(OFFLOAD_URL,{method:"POST",headers,body:JSON.stringify(payload)});
            if (r.ok){
              const j = await r.json().catch(()=> ({}));
              if (String(j.status||"").toLowerCase()!=="fail" && j.is_success!==false && (j.code==null || j.code>0)){
                ok = true; break;
              }
            }
          }catch(_e){}
        }
      }
      results.push(ok
        ? `${pro} -> ${DO} - successfully offloaded at ${terminal}`
        : `${pro} -> ${DO} - offload at ${terminal} failed`);
      setProg(i+1,total,start);
    }
    return results;
  }

  async function previewAll({terminal, pairs}){
    const start = now(); const total = pairs.length;
    setProg(0,total,start);
    const out = [];
    for (let i=0;i<pairs.length;i++){
      const [pro, DO] = pairs[i];
      const key = extractKey(DO);
      out.push(`${pro} -> ${DO} - DRY RUN (payload: ${JSON.stringify({order_status:"Override Offload", order_keys:[Number(key)], terminal})})`);
      setProg(i+1,total,start);
    }
    return out;
  }

  // Main
  async function run(dry=false){
    resetOutput();
    try{
      const termKey = kCanonical(termInput.value);
      if (!termKey || !TERM_MAP.has(termKey)) throw new Error("Please choose a valid terminal from the live list.");
      const terminal = TERM_MAP.get(termKey).value;

      const prosAll = parsePros(input.value);
      if (!prosAll.length) throw new Error("No PROs found.");
      const overflow = prosAll.length>MAX_ORDERS ? prosAll.slice(MAX_ORDERS) : [];
      const tracking = prosAll.slice(0,MAX_ORDERS);

      status.textContent = "Authenticating…";
      const token = await auth();

      status.textContent = `Searching ${tracking.length} order(s)…`;
      const data = await searchOrders(token, tracking);

      const map = buildMap(data);
      const pairs = []; const missing=[];
      for (const p of tracking){ map[p] ? pairs.push([p,map[p]]) : missing.push(p); }

      line(`Mapped ${pairs.length} PRO→DO; ${missing.length} without DO.`);
      if (dry){
        status.textContent = `Previewing ${pairs.length} mapped order(s)…`;
        const preview = await previewAll({terminal, pairs});
        preview.forEach(line);
      }else{
        status.textContent = `Offloading ${pairs.length} mapped order(s) at ${terminal}…`;
        const results = await offloadAll({token, terminal, pairs});
        results.forEach(line);
      }
      for (const p of missing) line(`${p} -> (no DO found) - not offloaded`);
      if (overflow.length){
        line(`NOT OFFLOADED (over ${MAX_ORDERS} cap):`);
        overflow.forEach(p=>line(`  ${p}`));
      }
      status.textContent = dry ? "Dry-run complete" : "Done";
      expBtn.disabled = !out.textContent.trim();
    }catch(e){
      status.textContent = "Error";
      line(`[Error] ${e.message||e}`);
      console.error(e);
    }
  }

  // Events
  runBtn.addEventListener("click", ()=> run(false));
  prevBtn.addEventListener("click", ()=> run(true));
  expBtn.addEventListener("click", ()=>{
    const blob = new Blob([out.textContent],{type:"text/plain;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `fms_offload_results_${new Date().toISOString().replace(/[:.]/g,"-")}.txt`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 800);
  });
  refreshBtn.addEventListener("click", async ()=>{
    disableRun(true);
    termMeta.textContent = "Refreshing…";
    try{ await fetchTerminals(); }catch(e){ termMeta.textContent = "Failed to load terminals"; console.error(e); }
  });

  // Browse (dropdown) interactions
  browseBtn.addEventListener("click", openModal);
  mclose.addEventListener("click", closeModal);
  mb.addEventListener("click", (e)=>{ if (e.target===mb) closeModal(); });
  msearch.addEventListener("input", ()=> renderList(msearch.value));
  window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });

  // Initial boot
  (async ()=>{
    try{
      termMeta.textContent = "Loading terminals…";
      await fetchTerminals();
    }catch(e){
      termMeta.textContent = "Failed to load terminals — try Refresh";
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>

